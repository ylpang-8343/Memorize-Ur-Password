{% extends "base.html" %}

{% block title %}设置 - 密码管理系统{% endblock %}

{% block page_title %}账户设置{% endblock %}

{% block page_subtitle %}管理您的个人资料和安全设置{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- settings navigation -->
    <div class="settings-sidebar">
        <div class="settings-nav">
            <button class="nav-item active" data-tab="profile">
                <i class="fas fa-user"></i>
                <span>个人资料</span>
            </button>
            <button class="nav-item" data-tab="security">
                <i class="fas fa-shield-alt"></i>
                <span>安全设置</span>
            </button>
            <button class="nav-item" data-tab="preferences">
                <i class="fas fa-cog"></i>
                <span>偏好设置</span>
            </button>
            <button class="nav-item" data-tab="backup">
                <i class="fas fa-download"></i>
                <span>备份与恢复</span>
            </button>
        </div>
    </div>

    <!-- settings content -->
    <div class="settings-content">
        <!-- profile tab -->
        <div class="tab-content active" id="profileTab">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">个人信息</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_profile') }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" id="username" name="username" class="form-control" 
                                       value="{{ user.username }}" disabled>
                                <div class="form-help">用户名创建后不可修改</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="email" class="form-label">邮箱地址 *</label>
                                <input type="email" id="email" name="email" class="form-control" 
                                       value="{{ user.email }}" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone" class="form-label">手机号码</label>
                                <input type="tel" id="phone" name="phone" class="form-control" 
                                       value="{{ user.phone or '' }}" 
                                       placeholder="例如: 0123456789">
                                <div class="form-help">用于接收安全验证码</div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 更新个人信息
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- security tab -->
        <div class="tab-content" id="securityTab">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">双重验证</h3>
                </div>
                <div class="card-body">
                    <div class="security-status">
                        <div class="status-item {% if user.otp_secret %}status-enabled{% else %}status-disabled{% endif %}">
                            <i class="fas fa-mobile-alt"></i>
                            <div class="status-info">
                                <h4>OTP验证</h4>
                                <p>通过手机应用生成的一次性密码进行验证</p>
                                <span class="status-badge">
                                    {% if user.otp_secret %}已启用{% else %}未启用{% endif %}
                                </span>
                            </div>
                            <button class="btn btn-outline" onclick="toggleOTP()">
                                {% if user.otp_secret %}禁用{% else %}启用{% endif %}
                            </button>
                        </div>
                    </div>

                    {% if user.otp_secret %}
                    <div class="otp-setup" id="otpSetup">
                        <div class="qr-code">
                            <img src="{{ url_for('generate_qr_code') }}" alt="QR Code">
                        </div>
                        <div class="otp-instructions">
                            <h4>设置说明:</h4>
                            <ol>
                                <li>使用Authenticator应用扫描二维码</li>
                                <li>或在应用中手动输入密钥: <code>{{ user.otp_secret }}</code></li>
                                <li>输入应用生成的6位验证码进行验证</li>
                            </ol>
                            <div class="form-group">
                                <input type="text" placeholder="输入验证码" class="form-control" 
                                       pattern="[0-9]{6}" maxlength="6">
                                <button class="btn btn-primary">验证</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">安全问题</h3>
                </div>
                <div class="card-body">
                    <div class="security-question-section">
                        <h4>当前安全问题:</h4>
                        <p class="security-question">{{ user.security_question or '未设置' }}</p>
                        
                        <form method="POST" action="{{ url_for('update_security_question') }}">
                            <div class="form-group">
                                <label for="security_question" class="form-label">安全问题</label>
                                <select id="security_question" name="security_question" class="form-control" required>
                                    <option value="">选择安全问题</option>
                                    <option value="您母亲的生日月份是？">您母亲的生日月份是？</option>
                                    <option value="您出生城市的名称是？">您出生城市的名称是？</option>
                                    <option value="您最喜欢的书是？">您最喜欢的书是？</option>
                                    <option value="您的小学校名是？">您的小学校名是？</option>
                                    <option value="您的第一个老师的名字是？">您的第一个老师的名字是？</option>
                                    <option value="您最喜欢的电影是？">您最喜欢的电影是？</option>
                                    <option value="您的座右铭是？">您的座右铭是？</option>
                                    <option value="您最喜欢的歌曲是？">您最喜欢的歌曲是？</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="security_answer" class="form-label">答案</label>
                                <input type="text" id="security_answer" name="security_answer" 
                                       class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="confirm_security_answer" class="form-label">确认答案</label>
                                <input type="text" id="confirm_security_answer" name="confirm_security_answer" 
                                       class="form-control" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 更新安全问题
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">会话管理</h3>
                </div>
                <div class="card-body">
                    <div class="sessions-list">
                        <h4>活跃会话</h4>
                        <div class="session-item current">
                            <div class="session-info">
                                <strong>当前会话</strong>
                                <span>登录时间: {{ session.get('login_time') }}</span>
                                <span>IP地址: {{ request.remote_addr }}</span>
                            </div>
                            <span class="session-status">活跃</span>
                        </div>
                        
                        <div class="session-actions">
                            <button class="btn btn-danger" onclick="logoutOtherDevices()">
                                <i class="fas fa-sign-out-alt"></i> 退出其他设备
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- preferences tab -->
        <div class="tab-content" id="preferencesTab">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">显示设置</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_preferences') }}">
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" name="auto_lock" {% if preferences.auto_lock %}checked{% endif %}>
                                <span class="checkmark"></span>
                                自动锁定（15分钟无操作后自动退出）
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" name="show_passwords" {% if preferences.show_passwords %}checked{% endif %}>
                                <span class="checkmark"></span>
                                默认显示密码
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" name="backup_reminder" {% if preferences.backup_reminder %}checked{% endif %}>
                                <span class="checkmark"></span>
                                每周备份提醒
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="theme" class="form-label">主题</label>
                            <select id="theme" name="theme" class="form-control">
                                <option value="light" {% if preferences.theme == 'light' %}selected{% endif %}>浅色主题</option>
                                <option value="dark" {% if preferences.theme == 'dark' %}selected{% endif %}>深色主题</option>
                                <option value="auto" {% if preferences.theme == 'auto' %}selected{% endif %}>跟随系统</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存偏好设置
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- backup tab -->
        <div class="tab-content" id="backupTab">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">数据备份</h3>
                </div>
                <div class="card-body">
                    <div class="backup-info">
                        <p>最后一次备份: {{ last_backup or '从未备份' }}</p>
                        <p>备份文件数量: {{ backup_count }}</p>
                    </div>

                    <div class="backup-actions">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="fas fa-download"></i> 创建备份
                        </button>
                        
                        <button class="btn btn-outline" onclick="restoreBackup()">
                            <i class="fas fa-upload"></i> 恢复备份
                        </button>
                        
                        <button class="btn btn-danger" onclick="exportData()">
                            <i class="fas fa-file-export"></i> 导出数据
                        </button>
                    </div>

                    <div class="backup-files">
                        <h4>备份文件</h4>
                        {% if backup_files %}
                        <div class="file-list">
                            {% for file in backup_files %}
                            <div class="file-item">
                                <i class="fas fa-file-archive"></i>
                                <span class="file-name">{{ file.name }}</span>
                                <span class="file-size">{{ file.size }}</span>
                                <span class="file-date">{{ file.date }}</span>
                                <div class="file-actions">
                                    <button class="btn-action" title="下载">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn-action" title="删除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="no-files">没有备份文件</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="content-card danger-zone">
                <div class="card-header">
                    <h3 class="card-title">危险区域</h3>
                </div>
                <div class="card-body">
                    <div class="danger-actions">
                        <div class="danger-item">
                            <h4>删除所有密码</h4>
                            <p>永久删除所有保存的密码记录</p>
                            <button class="btn btn-danger" onclick="openModal('deleteAllPasswordsModal')">
                                <i class="fas fa-trash"></i> 删除所有密码
                            </button>
                        </div>

                        <div class="danger-item">
                            <h4>注销账户</h4>
                            <p>永久删除账户和所有数据</p>
                            <button class="btn btn-danger" onclick="openDeleteAccountModal()">
                                <i class="fas fa-user-slash"></i> 注销账户
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- confirm modals -->
{% include 'main/modals/confirm_modals.html' %}
{% endblock %}

{% block extra_css %}
<style>
.settings-container {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 2rem;
    min-height: 600px;
}

.settings-sidebar {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 1.5rem;
    height: fit-content;
}

.settings-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border: none;
    background: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    color: var(--dark-color);
}

.nav-item:hover {
    background: var(--light-color);
}

.nav-item.active {
    background: var(--primary-color);
    color: white;
}

.nav-item i {
    width: 20px;
    text-align: center;
}

.settings-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.form-help {
    font-size: 0.875rem;
    color: var(--gray-color);
    margin-top: 0.25rem;
}

.security-status {
    margin-bottom: 1.5rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: var(--border-radius);
    background: var(--light-color);
}

.status-item.status-enabled {
    border-left: 4px solid var(--success-color);
}

.status-item.status-disabled {
    border-left: 4px solid var(--warning-color);
}

.status-item i {
    font-size: 2rem;
    color: var(--primary-color);
}

.status-info {
    flex: 1;
}

.status-info h4 {
    margin: 0 0 0.25rem 0;
    color: var(--dark-color);
}

.status-info p {
    margin: 0;
    color: var(--gray-color);
    font-size: 0.9rem;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-enabled .status-badge {
    background: var(--success-color);
    color: white;
}

.status-disabled .status-badge {
    background: var(--warning-color);
    color: var(--dark-color);
}

.otp-setup {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 2rem;
    padding: 1.5rem;
    background: var(--light-color);
    border-radius: var(--border-radius);
}

.qr-code {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    text-align: center;
}

.qr-code img {
    max-width: 100%;
    height: auto;
}

.otp-instructions ol {
    margin: 0;
    padding-left: 1.5rem;
}

.otp-instructions li {
    margin-bottom: 0.5rem;
}

.otp-instructions code {
    background: var(--light-color);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Monaco', 'Consolas', monospace;
}

.security-question-section {
    margin-bottom: 1.5rem;
}

.security-question {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--light-color);
    border-radius: var(--border-radius);
}

.sessions-list {
    margin-bottom: 1.5rem;
}

.session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    margin-bottom: 0.75rem;
}

.session-item.current {
    border-color: var(--primary-color);
    background: var(--light-color);
}

.session-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.session-info span {
    font-size: 0.9rem;
    color: var(--gray-color);
}

.session-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    background: var(--success-color);
    color: white;
}

.session-actions {
    margin-top: 1rem;
}

.backup-info {
    background: var(--light-color);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
}

.backup-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.btn-outline {
    background: white;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

.file-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--light-color);
    border-radius: var(--border-radius);
}

.file-name {
    flex: 1;
    font-weight: 500;
}

.file-size, .file-date {
    color: var(--gray-color);
    font-size: 0.9rem;
}

.file-actions {
    display: flex;
    gap: 0.5rem;
}

.no-files {
    text-align: center;
    color: var(--gray-color);
    padding: 2rem;
}

.danger-zone {
    border: 2px solid var(--danger-color);
}

.danger-item {
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.danger-item:last-child {
    border-bottom: none;
}

.danger-item h4 {
    color: var(--danger-color);
    margin: 0 0 0.5rem 0;
}

.danger-item p {
    color: var(--gray-color);
    margin: 0 0 1rem 0;
}

/* responsive design */
@media (max-width: 968px) {
    .settings-container {
        grid-template-columns: 1fr;
    }
    
    .settings-sidebar {
        order: 2;
    }
    
    .settings-nav {
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    
    .nav-item {
        white-space: nowrap;
    }
    
    .otp-setup {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .backup-actions {
        flex-direction: column;
    }
}

@media (max-width: 768px) {
    .status-item {
        flex-direction: column;
        text-align: center;
    }
    
    .file-item {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
    
    .file-name, .file-size, .file-date {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// toggle tabs
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        
        // update active nav item
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        this.classList.add('active');
        
        // show specified tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + 'Tab').classList.add('active');
    });
});

// OTP toggle
function toggleOTP() {
    fetch('/toggle-otp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError('操作失败：' + data.message);
        }
    })
    .catch(error => {
        showError('网络错误：' + error.message);
    });
    console.log('切换OTP设置');
}

// backup actions
function createBackup() {
    openModal('backupConfirmModal');
    console.log('创建备份');
}

function restoreBackup() {
    openModal('restoreConfirmModal');
    console.log('恢复备份');
}

function exportData() {
    openModal('exportConfirmModal');
    console.log('导出数据');
}

// danger actions
function confirmDeleteAllPasswords() {
    openModal('deleteAllPasswordsModal');
    console.log('确认删除所有密码');
}

function openDeleteAccountModal() {
    openModal('deleteAccountModal');
}

function logoutOtherDevices() {
    openModal('logoutOtherDevicesModal');
    console.log('退出其他设备');
}

function debugModal() {
    console.log('Checking modals...');
    const modals = ['deleteAccountModal', 'successModal', 'errorModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        console.log(modalId, 'exists:', !!modal);
        if (modal) {
            console.log(modalId, 'display:', modal.style.display);
        }
    });
}

// initialise when document is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('设置页面已加载');
    debugModal();

    window.testModal = function() {
        openModal('deleteAccountModal');
    };
});
</script>
{% endblock %}